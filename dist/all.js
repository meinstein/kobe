function loadData(){var t="data/KB_MASTER.json";d3.json(t,function(t,e){return t?console.warn(t):(data=e,renderTemplate("1997"),highlightDropdownSeason($("#1997")),formatLineData(),addEventHandlers(),initLineChart(),void setTimeout(function(){cloneHeader()},1e3))})}function renderTemplate(t){$stat_button.eq(stat).addClass("selected"),thisSeason=data[t],$template_holder=$("#template_holder"),$template_holder.fadeOut("fast",function(){$(this).empty();var t=$("#template").html(),e=Mustache.render(t,thisSeason);$(this).html(e),$(this).fadeIn("slow"),$("#footer").fadeIn("slow"),bindData(),setTimeout(function(){sortEvents()},1200)})}function bindData(){d3.selectAll(".container").data(thisSeason.games).enter(),d3.selectAll(".container").select(".game_date").html(function(t){var e=t.g[5],a=e.substring(0,e.length-3);return 0==t.g[4]?a:a+" <span class='playoff_game'>●</span> "}),d3.selectAll(".container").select(".opp").html(function(t){return 1==t.g[6]?"<span class='at-margin'>@</span>"+t.g[7]:t.g[7]}),d3.selectAll(".container").select(".change").html(function(t){return t.g[stat]}),d3.selectAll(".season_avg").html(thisSeason.avg[stat]),d3.selectAll(".career_avg").html(career[stat]),d3.select("#stat_total").html(format(thisSeason.totals[stat])),d3.select("#games_played").html(thisSeason.games.length),initScales(),initMarkers(),initBar()}function initBar(){d3.selectAll(".container").select(".d1").style("width",function(t){return scale(t.g[stat])+"%"}).style("opacity",function(t){return oScale(t.g[stat])})}function initMarkers(){d3.selectAll(".d2").style("width",scale(thisSeason.avg[stat])+"%"),d3.selectAll(".d3").style("width",scale(career[stat])+"%")}function initAbout(){$("#about").fadeIn("fast")}function closeAbout(){$("#about").fadeOut("fast")}function initScales(){max=d3.max(thisSeason.games,function(t){return t.g[stat]}),max<career[stat]&&(max=career[stat]),scale=d3.scale.linear().domain([0,max]).range([0,96]),oScale=d3.scale.linear().domain([0,max]).range([.4,1])}function toggleData(t,e,a){var n=Object.keys(data),r=0;if(0===e&&(n.forEach(function(t){data[t].games.forEach(function(t){var e=t.g[5].split("/",2),n=e[0]+"/"+e[1];n===a&&(r+=1)})}),t.closest(".container").next().find(".toggle-text").html('<i class="fa fa-close toggle-text-close"></i> KB played a total of '+r+" games on "+formatMonthYear(new Date(a))+" throughout his career.")),1===e){var i;teamsDict.hasOwnProperty(a)?i=teamsDict[a]:teamsConverted=a,n.forEach(function(t){data[t].games.forEach(function(t){var e=t.g[7];e===a&&(r+=1)})}),t.closest(".container").next().find(".toggle-text").html('<i class="fa fa-close toggle-text-close"></i> KB played '+r+" games against the "+i+" during his career.")}2===e&&(n.forEach(function(t){data[t].games.forEach(function(t){var e=t.g[stat];e==a&&(r+=1)})}),t.closest(".container").next().find(".toggle-text").html('<i class="fa fa-close toggle-text-close"></i> KB '+statVerbArray[stat]+" a total of "+a+" "+statNameArray[stat]+" "+r+" different times during his career."))}function toggleIcon(t,e){t.closest(".container").next().is(":visible")&&e===lastIconIndex?(t.closest(".container").next().toggle(),$("td.toggle-data").removeClass("td-selected")):t.closest(".container").next().is(":visible")&&e!==lastIconIndex?($("td.toggle-data").removeClass("td-selected"),t.addClass("td-selected")):($("tr.toggle-row").hide(),$("td.toggle-data").removeClass("td-selected"),t.closest(".container").next().toggle(),t.addClass("td-selected")),lastIconIndex=e}function addEventHandlers(){$(document).on("click",".toggle-data",function(){var t,e=$(this),a=e.index();if(1==a){var n=e.html();t=n.slice(-3)}else t=e.html();toggleIcon(e,a),toggleData(e,a,t)}),$(document).on("click",".toggle-text-close",function(){$(this).closest(".toggle-row").hide(),$("td.toggle-data").removeClass("td-selected")}),$("#title").on("click",function(t){t.stopPropagation(),initAbout()}),$("#about").on("click",function(t){t.stopPropagation(),closeAbout()}),$stat_button.on("click",function(){if(stat=$(this).index(),$(this).addClass("selected").siblings().removeClass("selected"),stat!==stat_before&&(initScales(),transition(),lineTransition()),"stat-sort"===currentRoute){var t=$(".stat-sort");t.find(".fa").css("color","#eee"),t.find(".fa").removeClass("fa-angle-down"),t.find(".fa").addClass("fa-angle-up")}stat_before=stat}),$(".fa-angle-left").on("click",function(){var t=$dropbtn.html(),e=t.substring(0,4),a=parseInt(e);1996===a&&(a=2016);var n=$("#"+a);highlightDropdownSeason(n);var r=n.text(),i=r.replace(/[^\x00-\x7F]/g,"");$dropbtn.html(i),renderTemplate(a),lineYear=a,moveSeasonCircle(),$("#header-fixed").empty(),cloneHeader()}),$(".fa-angle-right").on("click",function(){var t=$dropbtn.html(),e=t.substring(0,4),a=parseInt(e)+2;2017===a&&(a=1997);var n=$("#"+a);highlightDropdownSeason(n);var r=n.text(),i=r.replace(/[^\x00-\x7F]/g,"");$dropbtn.html(i),renderTemplate(a),lineYear=a,moveSeasonCircle(),$("#header-fixed").empty(),cloneHeader()}),$dropbtn.on("click",function(){$(".dropdown-content").addClass("visible"),$(".dropdown-content ul").slideToggle("fast",function(){$(this).is(":visible")||$(".dropdown-content").removeClass("visible")})}),$dd_li.on("click",function(){var t=$(this),e=t.attr("id");renderTemplate(e),highlightDropdownSeason(t),lineYear=e;var a=t.text(),n=a.replace(/[^\x00-\x7F]/g,"");$dropbtn.html(n),moveSeasonCircle(),$("#header-fixed").empty(),cloneHeader()}),$(document).on("click",function(t){$(t.target).is(".dropbtn")||($(".dropdown-content ul").hide(),$(".dropdown-content").removeClass("visible"))})}function sortEvents(){$sort=$(".sort"),$sort.on("click",function(){var t=$(this).attr("class"),e=t.split(" ")[0];$sort.find(".fa").css("color","#eee"),$("."+e).find(".fa").css("color","indianred"),toggleSortArrows(e)})}function transition(){$(".toggle-row").hide(),$(".toggle-data").removeClass("td-selected"),d3.selectAll(".season_avg").style("opacity",0).html(thisSeason.avg[stat]).transition().duration(500).style("opacity",1),d3.selectAll(".career_avg").style("opacity",0).html(career[stat]).transition().duration(500).style("opacity",1),d3.select("#stat_total").html(format(thisSeason.totals[stat])),d3.selectAll(".container").select(".change").style("opacity",0).html(function(t){return t.g[stat]}).transition().duration(500).style("opacity",1),d3.selectAll(".container").select(".d1").transition().duration(1e3).styleTween("width",function(t,e,a){return d3.interpolateString(this.style.width,scale(t.g[stat])+"%")}).style("opacity",function(t){return oScale(t.g[stat])}),d3.selectAll(".d2").transition().duration(1e3).styleTween("width",function(t,e,a){return d3.interpolateString(this.style.width,scale(thisSeason.avg[stat])+"%")}),d3.selectAll(".d3").transition().duration(1e3).styleTween("width",function(t,e,a){return d3.interpolateString(this.style.width,scale(career[stat])+"%")})}function formatLineData(){var t=_.keys(data);for(seasons in t)line_data.push({year:t[seasons],avg:data[t[seasons]].avg,totals:data[t[seasons]].totals})}function sortData(t){currentRoute=t,"date-sort"===t&&thisSeason.games.sort(function(t,e){return t.g[8]-e.g[8]}),"opp-sort"===t&&thisSeason.games.sort(function(t,e){return d3.ascending(t.g[7],e.g[7])||t.g[8]-e.g[8]}),"stat-sort"===t&&thisSeason.games.sort(function(t,e){return e.g[stat]-t.g[stat]||t.g[8]-e.g[8]}),updateForSort()}function updateForSort(){$(".toggle-row").hide(),$(".toggle-data").removeClass("td-selected");var t=d3.selectAll(".container").data(thisSeason.games);t.exit().remove(),t.enter(),d3.selectAll(".container").select(".d1").style("opacity",0).style("width",function(t){return scale(t.g[stat])+"%"}).transition().duration(1e3).style("opacity",function(t){return oScale(t.g[stat])}),d3.selectAll(".container").select(".change").style("opacity",0).html(function(t){return t.g[stat]}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".game_date").style("opacity",0).html(function(t){var e=t.g[5],a=e.substring(0,e.length-3);return 0==t.g[4]?a:a+" <span class='playoff_game'>●</span> "}).transition().duration(1e3).style("opacity",1),d3.selectAll(".container").select(".opp").style("opacity",0).html(function(t){return 1==t.g[6]?"<span class='at-margin'>@</span>"+t.g[7]:t.g[7]}).transition().duration(1e3).style("opacity",1)}function initLineChart(){avgMax=d3.max(line_data,function(t){return t.avg[stat]}),totalsMax=d3.max(line_data,function(t){return t.totals[stat]}),width=parseInt(d3.select("#line_chart").style("width"),10),height=parseInt(d3.select("#line_chart").style("height"),10)/2;var t=d3.select("#line_chart").append("svg").attr("width",width).attr("height",2*height).style("background","#1c1c1c");x=d3.time.scale().range([margin.left,width-margin.right]).domain([1997,2016]),y=d3.scale.linear().range([height,margin.top]).domain([0,avgMax]),y2=d3.scale.linear().range([height,2*height-margin.bottom]).domain([0,totalsMax]),lineGenAvg=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y(t.avg[stat])}).interpolate("cardinal"),lineGenTotals=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),areaAvg=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y(t.avg[stat])}).interpolate("cardinal"),areaTotals=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),t.append("path").datum(line_data).attr("class","area-avg").attr("fill","#3090c7").attr("opacity",.75).attr("shape-rendering","geometricPrecision").attr("d",areaAvg),t.append("path").datum(line_data).attr("class","area-totals").attr("fill","#eee").attr("opacity",.75).attr("shape-rendering","geometricPrecision").attr("d",areaTotals),t.append("svg:path").attr("d",lineGenAvg(line_data)).attr("class","line-avg").attr("stroke","#3090c7").attr("stroke-width",2).attr("opacity",1).attr("shape-rendering","geometricPrecision").attr("fill","none"),t.append("svg:path").attr("d",lineGenTotals(line_data)).attr("class","line-totals").attr("stroke","#eee").attr("stroke-width",2).attr("opacity",1).attr("shape-rendering","geometricPrecision").attr("fill","none"),marker_connector=t.append("svg:line").attr("class","career-avg").attr("x1",margin.left).attr("y1",y(career[stat])).attr("x2",width-margin.right).attr("y2",y(career[stat])).style("stroke-width","2").style("stroke-dasharray","6, 4").style("opacity",1).style("stroke","#ffb400"),marker_connector=t.append("svg:line").attr("class","marker-connector").attr("x1",x(2016)).attr("y1",margin.top-margin.top/2).attr("x2",x(2016)).attr("y2",2*height-margin.bottom+margin.bottom/2).style("stroke-width","2").style("opacity",1).style("stroke","rgba(255,255,255,1)"),t.append("circle").attr("class","label-circles").attr("cx",x(2016)).attr("cy",margin.top-margin.top/2).attr("r",6).attr("fill","#eee"),t.append("circle").attr("class","label-circles").attr("cx",x(2016)).attr("cy",margin.top-margin.top/2).attr("r",4).attr("fill","#3090c7"),t.append("text").attr("class","text season-avg labels").attr("x",function(){return lineYear>2006?x(lineYear)-labelMargin:x(lineYear)+labelMargin}).attr("y",margin.top-14).attr("text-anchor",function(){return lineYear>2006?"end":"start"}).attr("fill","#eee").attr("font-size","0.85em").style("opacity",0).text("Season Avg: "+thisSeason.avg[stat]),t.append("circle").attr("class","label-circles").attr("cx",x(2016)).attr("cy",2*height-margin.bottom+margin.bottom/2).attr("r",6).attr("fill","#eee"),t.append("circle").attr("class","label-circles").attr("cx",x(2016)).attr("cy",2*height-margin.bottom+margin.bottom/2).attr("r",4).attr("fill","#eee"),t.append("text").attr("class","text season-total labels").attr("x",function(){return lineYear>2006?x(lineYear)-labelMargin:x(lineYear)+labelMargin}).attr("y",2*height-margin.bottom+16).attr("text-anchor",function(){return lineYear>2006?"end":"start"}).attr("fill","#eee").attr("font-size","0.85em").style("opacity",0).text("Season Total: "+format(thisSeason.totals[stat])),d3.selectAll(".label-circles").transition().duration(1200).attr("cx",x(lineYear)),d3.selectAll(".marker-connector").transition().duration(1200).attr("x1",x(lineYear)).attr("x2",x(lineYear)),d3.selectAll(".labels").transition().delay(900).duration(500).style("opacity",1)}function resize(){width=parseInt(d3.select("#line_chart").style("width"),10),x=d3.time.scale().range([margin.left,width-margin.right]).domain([1997,2016]),y=d3.scale.linear().range([height,margin.top]).domain([0,avgMax]),y2=d3.scale.linear().range([height,2*height-margin.bottom]).domain([0,totalsMax]),d3.select("svg").attr("width",width),areaAvg=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y(t.avg[stat])}).interpolate("cardinal"),areaTotals=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),lineGenAvg=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y(t.avg[stat])}).interpolate("cardinal"),lineGenTotals=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),d3.selectAll(".avg_marker").attr("transform","translate("+x(lineYear)+","+y(thisSeason.avg[stat])+")"),d3.selectAll(".totals_marker").attr("transform","translate("+x(lineYear)+","+y2(thisSeason.totals[stat])+")"),d3.select("line.marker-connector").attr("x1",x(lineYear)).attr("x2",x(lineYear)),d3.select("line.career-avg").attr("x1",margin.left).attr("x2",width-margin.right),d3.select("line.middle-line").attr("x1",margin.left).attr("x2",width+margin.right),d3.selectAll(".career_marker").attr("x2",width+margin.right),d3.select("path.line-avg").attr("d",lineGenAvg(line_data)),d3.select("path.line-totals").attr("d",lineGenTotals(line_data)),d3.select("path.area-avg").datum(line_data).attr("d",areaAvg),d3.select("path.area-totals").datum(line_data).attr("d",areaTotals),d3.selectAll(".label-circles").attr("cx",x(lineYear)),d3.selectAll("text.labels").attr("x",function(){return lineYear>2006?x(lineYear)-labelMargin:x(lineYear)+labelMargin})}function lineTransition(){width=parseInt(d3.select("#line_chart").style("width"),10),avgMax=d3.max(line_data,function(t){return t.avg[stat]}),totalsMax=d3.max(line_data,function(t){return t.totals[stat]}),x=d3.time.scale().range([margin.left,width-margin.right]).domain([1997,2016]),y=d3.scale.linear().range([height,margin.top]).domain([0,avgMax]),y2=d3.scale.linear().range([height,2*height-margin.bottom]).domain([0,totalsMax]),d3.select("svg").attr("width",width),d3.select("text.season-avg").text("Season Avg: "+thisSeason.avg[stat]),d3.select("text.season-total").text("Season Total: "+format(thisSeason.totals[stat])),areaAvg=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y(t.avg[stat])}).interpolate("cardinal"),lineGenAvg=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y(t.avg[stat])}).interpolate("cardinal"),areaTotals=d3.svg.area().x(function(t){return x(t.year)}).y0(height).y1(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),lineGenTotals=d3.svg.line().x(function(t){return x(t.year)}).y(function(t){return y2(t.totals[stat])}).interpolate("cardinal"),d3.selectAll(".avg_marker").transition().duration(1e3).attr("transform","translate("+x(lineYear)+","+y(thisSeason.avg[stat])+")"),d3.selectAll(".totals_marker").transition().duration(1e3).attr("transform","translate("+x(lineYear)+","+y2(thisSeason.totals[stat])+")"),d3.select("line.career-avg").transition().duration(1e3).attr("y1",y(career[stat])).attr("y2",y(career[stat])),d3.select("path.line-avg").transition().duration(1e3).attr("d",lineGenAvg(line_data)),d3.select("path.area-avg").datum(line_data).transition().duration(1e3).attr("d",areaAvg),d3.select("path.line-totals").transition().duration(1e3).attr("d",lineGenTotals(line_data)),d3.select("path.area-totals").datum(line_data).transition().duration(1e3).attr("d",areaTotals)}function moveSeasonCircle(){x=d3.time.scale().range([margin.left,width-margin.right]).domain([1997,2016]),y=d3.scale.linear().range([height,margin.top]).domain([0,avgMax]),y2=d3.scale.linear().range([height,2*height-margin.bottom]).domain([0,totalsMax]),d3.selectAll(".avg_marker").style("opacity",0).attr("transform","translate("+x(lineYear)+","+y(thisSeason.avg[stat])+")").transition().duration(1e3).style("opacity",1),d3.selectAll(".totals_marker").style("opacity",0).attr("transform","translate("+x(lineYear)+","+y2(thisSeason.totals[stat])+")").transition().duration(1e3).style("opacity",1),d3.selectAll(".label-circles").transition().duration(1e3).attr("cx",x(lineYear)).style("opacity",1),d3.select("line.marker-connector").transition().duration(1e3).attr("x1",x(lineYear)).attr("y1",margin.top-margin.top/2).attr("x2",x(lineYear)).attr("y2",2*height-margin.bottom+margin.bottom/2),d3.select("text.season-avg").style("opacity",0).attr("x",function(){return lineYear>2006?x(lineYear)-labelMargin:x(lineYear)+labelMargin}).attr("text-anchor",function(){return lineYear>2006?"end":"start"}).transition().duration(1200).style("opacity",1).text("Season Avg: "+format(thisSeason.avg[stat])),d3.select("text.season-total").style("opacity",0).attr("x",function(){return lineYear>2006?x(lineYear)-labelMargin:x(lineYear)+labelMargin}).attr("text-anchor",function(){return lineYear>2006?"end":"start"}).transition().duration(1200).style("opacity",1).text("Season Total: "+format(thisSeason.totals[stat]))}function toggleSortArrows(t){var e=$("."+t),a=e.find(".fa"),n=e.siblings().find(".fa");a.hasClass("fa-angle-down")||(n.removeClass("fa-angle-down"),n.addClass("fa-angle-up"),a.removeClass("fa-angle-up"),a.addClass("fa-angle-down"),sortData(t))}function highlightDropdownSeason(t){t.siblings().removeClass("selected"),t.addClass("selected")}function cloneHeader(){var t=$("#table-1 > thead").clone(),e=$("#header-fixed").append(t);setInterval(function(){var t=$(window).scrollTop();t>=tableOffset&&e.is(":hidden")?e.show():t<tableOffset&&e.hide()},100)}var data,max,avgMax,totalsMax,scale,oScale,thisSeason,stat=0,stat_before=0,lineYear=1997,currentRoute="date-sort",format=d3.format("0,000"),lastIconIndex=-1,formatMonthYear=d3.time.format("%B %-d"),lineGen,area,careerLine,width,height,x,y,line_data=[],labelMargin=10,yearLabelRight,margin={top:30,right:8,bottom:30,left:8},career=[25.1,5.3,4.7,36.3],statNameArray=["points","rebounds","assists","minutes"],statVerbArray=["scored","had","had","played"],$sort,$stat_button=$(".stat_button"),$dd_li=$(".dropdown-content li"),$dropbtn=$(".dropbtn"),$dd_content=$(".dropdown-content"),teamsDict={CHI:"Chicago Bulls",ATL:"Atlanta Hawks",CLE:"Cleveland Cavaliers",DET:"Detroit Pistons",CHA:"Charlotte Hornets",IND:"Indiana Pacers",BOS:"Boston Celtics",MIA:"Miami Heat",NYK:"New York Knicks",ORL:"Orlando Magic",TOR:"Toronto Raptors",WAS:"Washington Wizards",MIL:"Milwaukee Bucks",BRK:"Brooklyn Nets",PHI:"Philadelphia 76ers",GSW:"Golden State Warriors",SAS:"San Antonio Spurs",DAL:"Dallas Mavericks",LAC:"Los Angeles Clippers",MEM:"Memphis Grizzlies",OKC:"Oklahoma City Thunder",UTA:"Utah Jazz",DEN:"Denver Nuggets",PHO:"Phoenix Suns",HOU:"Houston Rockets",MIN:"Minnesota Timberwolves",POR:"Portland Trail Blazers",SAC:"Sacramento Kings",LAL:"Los Angeles Lakers",NOP:"New Orleans Pelicans",CHA:"Charlotte Hornets/Bobcats",VAN:"Vancouver Grizzlies",NOH:"New Orleans Hornets",NOK:"New Orleans/Oklahoma City Hornets",SEA:"Seattle SuperSonics",NJN:"New Jersey Nets"},tableOffset=185;$(window).resize(function(){resize()}),$(document).ready(function(){loadData()});